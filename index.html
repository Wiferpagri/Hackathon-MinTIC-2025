<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE DE CALIDAD IGAC - Transacciones Inmobiliarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilo para la fila seleccionable */
        .data-row:hover {
            cursor: pointer;
            background-color: #f0f4f8;
        }
        /* Estilo para la tabla sticky header */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        /* Estilos botones filtro */
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto">
        
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-2 leading-tight">
                REPORTE ANALÍTICO DE CALIDAD EN EL REGISTRO DE TRANSACCIONES INMOBILIARIAS EN COLOMBIA IGAC 2015 - 2023
            </h1>

            <p class="text-sm font-bold text-indigo-600 tracking-wider uppercase mt-4">ENTIDAD: Instituto Geográfico Agustín Codazzi</p>
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mt-2 mb-6">
                <p class="text-xl font-medium text-gray-800">
                    ANÁLISIS Y DETECCIÓN DE ANOMALÍAS 
                    <span class="block md:inline text-base font-normal text-gray-500 ml-0 md:ml-2">(30.9 Millones de Registros 2015-2023)</span>
                </p>
            </div>
            
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner border-l-4 border-gray-400 mb-8">
                <p class="text-sm text-gray-700 font-medium">Sistema de monitoreo y detección de anomalías en transacciones inmobiliarias de Colombia.</p>
                <div class="flex flex-col sm:flex-row sm:space-x-8 mt-2 text-xs text-gray-600">
                    <p><span class="font-bold text-gray-800">Fecha de Corte de Datos:</span> 30 de Noviembre de 2025</p>
                    <p><span class="font-bold text-gray-800">Versión del Reporte:</span> v1.0.0</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-indigo-600 relative overflow-hidden">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide z-10 relative">Puntaje Calidad</p>
                <div class="flex items-baseline mt-2 relative z-10">
                    <p id="puntaje-promedio" class="text-3xl font-extrabold text-gray-900">--</p>
                    <span class="text-sm text-gray-500 ml-1 font-medium">/ 100</span>
                </div>
            </div>
            
            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-purple-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Reglas Evaluadas</p>
                <p id="total-reglas" class="text-3xl font-extrabold text-gray-900 mt-2">--</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Total Registros</p>
                <p id="total-registros" class="text-2xl font-extrabold text-gray-900 mt-2">--</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-orange-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Hallazgos de Consistencia</p>
                <p id="pct-hallazgos" class="text-3xl font-extrabold text-orange-600 mt-2">--</p>
                <p class="text-[10px] text-gray-400 mt-1">(Excluye errores de formato)</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">% Estado Crítico</p>
                <p id="pct-criticos" class="text-3xl font-extrabold text-red-600 mt-2">--</p>
                <p class="text-[10px] text-gray-400 mt-1">(Score < 90 o 2+ errores de consistencia)</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2">
                <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100">
                    
                    <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50/50">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Detalle de Reglas de Calidad</h2>
                            <p class="text-xs text-gray-500 mt-1">Haga clic en una fila para ver el detalle técnico.</p>
                        </div>
                        
                        <div class="flex space-x-1 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                            <button onclick="filterTable('all')" id="btn-all" class="filter-btn active px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Todas</button>
                            <button onclick="filterTable('Formato')" id="btn-fmt" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Formato</button>
                            <button onclick="filterTable('Consistencia')" id="btn-cst" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Consistencia</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky-header">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Regla (Nombre Legible)</th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Reg. Afectados</th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">% Afectación</th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-gray-50 text-xs text-center text-gray-500 border-t">
                        Mostrando <span id="rows-count" class="font-bold">0</span> reglas activas
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white shadow-xl rounded-xl p-6 border border-gray-100 h-full">
                    <h3 class="text-lg font-bold text-indigo-900 mb-6 flex items-center border-b pb-4">
                        <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Metodología de Cálculo
                    </h3>
                    
                    <div class="space-y-8 text-sm text-gray-600">
                        
                        <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-100 relative">
                            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500 rounded-l-lg"></div>
                            <p class="font-bold text-indigo-900 mb-3 text-base">Fórmula de Puntaje</p>
                            <div class="font-mono text-sm bg-white p-3 rounded border border-indigo-200 mb-3 text-center text-indigo-700 font-bold shadow-sm">
                                SCORE = 100 - Σ(Penalización)
                            </div>
                            <p class="text-xs leading-relaxed text-indigo-800">
                                Cada registro inicia con <span class="font-bold">100 puntos base</span>. Se restan puntos acumulativos por cada regla de calidad que el registro incumpla.
                            </p>
                        </div>

                        <div>
                            <h4 class="font-bold text-gray-800 mb-4 text-base">Pesos y Ponderación</h4>
                            <p class="mb-4 text-xs leading-relaxed text-gray-500">
                                El modelo penaliza con mayor severidad los errores que comprometen la integridad analítica del dato (Consistencia) frente a los errores estéticos (Formato).
                            </p>
                            
                            <ul class="space-y-4">
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs mr-3">F</div>
                                    <div>
                                        <span class="block font-bold text-gray-900">Errores de Formato</span>
                                        <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">Peso Bajo</span>
                                        <p class="text-xs mt-1 text-gray-500">Sintaxis, mayúsculas o caracteres especiales. No invalidan el uso del dato.</p>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs mr-3">C</div>
                                    <div>
                                        <span class="block font-bold text-gray-900">Errores de Consistencia</span>
                                        <span class="text-xs font-semibold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">Peso Alto</span>
                                        <p class="text-xs mt-1 text-gray-500">Lógica de negocio rota (fechas futuras, valor cero, duplicados). Invalidan el registro.</p>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <div class="border-t pt-4 mt-2">
                            <p class="text-xs italic text-gray-400">
                                * Nota: Se considera "Registro Crítico" a cualquier transacción con un puntaje final inferior a **90** puntos o que acumule dos o más errores de Consistencia.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div>

    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-0 transform transition-all scale-100 overflow-hidden">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg">Detalle de la Regla</h3>
                <button onclick="closeModal()" class="text-indigo-200 hover:text-white text-2xl font-bold leading-none focus:outline-none">&times;</button>
            </div>
            
            <div class="p-6 space-y-5">
                <div>
                    <h4 id="modal-title" class="text-xl font-bold text-gray-800 mb-1">Nombre de la Regla</h4>
                    <p id="modal-technical-name" class="font-mono text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded inline-block border border-indigo-100">nombre_tecnico</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Descripción Técnica</p>
                    <p id="modal-description" class="text-sm text-gray-700 leading-relaxed">Descripción detallada...</p>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded focus:outline-none transition">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];

        function initDashboard() {
            // Cargar JSON (Asumimos que el JSON está en 'data_reporte_calidad.json')
            fetch('data_reporte_calidad.json')
                .then(res => {
                    if (!res.ok) throw new Error("No se pudo cargar data_reporte_calidad.json");
                    return res.json();
                })
                .then(data => {
                    fullData = data.ruleMetrics;
                    updateExecutiveSummary(data.executiveSummary);
                    filterTable('all'); // Carga inicial de la tabla
                })
                .catch(err => {
                    console.error("Error:", err);
                    document.getElementById('total-registros').textContent = 'ERROR';
                    document.getElementById('puntaje-promedio').textContent = 'N/A';
                    alert("Error cargando los datos. Asegúrese de ejecutar el script PySpark primero.");
                });
        }

        function updateExecutiveSummary(summary) {
            document.getElementById('puntaje-promedio').textContent = summary.puntaje_promedio;
            document.getElementById('total-registros').textContent = summary.total_registros;
            document.getElementById('pct-criticos').textContent = summary.porcentaje_criticos;
            
            // Tarjetas corregidas
            document.getElementById('total-reglas').textContent = summary.total_reglas;
            document.getElementById('pct-hallazgos').textContent = summary.porcentaje_hallazgos_global;
        }

        function filterTable(type) {
            // 1. Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            
            let activeBtnId = 'btn-all';
            if(type === 'Formato') activeBtnId = 'btn-fmt';
            if(type === 'Consistencia') activeBtnId = 'btn-cst';
            
            const activeBtn = document.getElementById(activeBtnId);
            activeBtn.classList.remove('bg-white', 'text-gray-600');
            activeBtn.classList.add('active');

            // 2. Filtrar Datos
            let filteredData = fullData;
            if (type !== 'all') {
                filteredData = fullData.filter(item => item.type === type);
            }

            renderTable(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            document.getElementById('rows-count').textContent = data.length;

            data.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'data-row border-b border-gray-50 hover:bg-indigo-50 transition duration-150';
                row.onclick = () => showDetails(item);

                // Nombre
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm font-medium text-gray-900">${item.readable_name}</div>`;
                
                // Conteo
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm text-gray-500 text-right font-mono">${item.affected_count}</div>`;

                // Porcentaje
                const pctVal = parseFloat(item.affected_pct.replace('%','').replace(',', '.'));
                let colorClass = 'text-green-600 font-medium';
                if(pctVal > 5) colorClass = 'text-orange-500 font-semibold';
                if(pctVal > 15) colorClass = 'text-red-600 font-bold';

                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm text-right ${colorClass}">${item.affected_pct}</div>`;

                // Tipo Badge
                const badgeColor = item.type === 'Consistencia' ? 'bg-indigo-100 text-indigo-800 border-indigo-200' : 'bg-blue-100 text-blue-800 border-blue-200';
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-center"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border ${badgeColor}">${item.type}</span></div>`;
            });
        }

        function showDetails(item) {
            document.getElementById('modal-title').textContent = item.readable_name;
            document.getElementById('modal-technical-name').textContent = item.technical_name;
            document.getElementById('modal-description').textContent = item.description;
            
            const modal = document.getElementById('modal-container');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('modal-container');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.keyCode == 27) {
                closeModal();
            }
        };

        window.onload = initDashboard;
    </script>
</body>
</html>