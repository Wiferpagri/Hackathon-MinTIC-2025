<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE DE CALIDAD IGAC - Transacciones Inmobiliarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilo para la fila seleccionable */
        .data-row:hover {
            cursor: pointer;
            background-color: #f0f4f8;
        }
        /* Estilo para la tabla sticky header */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        /* Estilos botones filtro */
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto">
        
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-2 leading-tight">
                REPORTE ANALÍTICO DE CALIDAD EN EL REGISTRO DE TRANSACCIONES INMOBILIARIAS EN COLOMBIA IGAC 2015 - 2023
            </h1>

            <p class="text-sm font-bold text-indigo-600 tracking-wider uppercase mt-4">ENTIDAD: Instituto Geográfico Agustín Codazzi</p>
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mt-2 mb-6">
                <p class="text-xl font-medium text-gray-800">
                    Reporte calidad de datos.
                    <span class="block md:inline text-base font-normal text-gray-500 ml-0 md:ml-2">(30.9 Millones de Registros 2015-2023)</span>
                </p>
            </div>
            
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner border-l-4 border-gray-400 mb-8">
                <p class="text-sm text-gray-700 font-medium">Sistema de monitoreo y detección de anomalías en transacciones inmobiliarias de Colombia.</p>
                <div class="flex flex-col sm:flex-row sm:space-x-8 mt-2 text-xs text-gray-600">
                    <p><span class="font-bold text-gray-800">Fecha de Corte de Datos:</span> 30 de Noviembre de 2025</p>
                    <p><span class="font-bold text-gray-800">Versión del Reporte:</span> v1.0.0</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div id="score-card" onclick="showScoreDocs()"
                class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-indigo-600 relative overflow-hidden cursor-pointer hover:shadow-lg transition duration-200">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide z-10 relative">
                    SCORE DE CALIDAD PROMEDIO
                    <span class="ml-1 text-indigo-400">
                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                </p>
                <div class="flex items-baseline mt-2 relative z-10">
                    <p id="puntaje-promedio" class="text-3xl font-extrabold text-gray-900">--</p>
                    <span class="text-sm text-gray-500 ml-1 font-medium">/ 100</span>
                </div>
            </div>
            
            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-purple-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Reglas Evaluadas</p>
                <p id="total-reglas" class="text-3xl font-extrabold text-gray-900 mt-2">--</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Total Registros</p>
                <p id="total-registros" class="text-2xl font-extrabold text-gray-900 mt-2">--</p>
            </div>

            <div id="hallazgos-card" onclick="showHallazgosDocs()" 
                class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-orange-500 cursor-pointer hover:shadow-lg transition duration-200">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">
                    Hallazgos de Consistencia
                    <span class="ml-1 text-orange-400">
                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                </p>
                <p id="pct-hallazgos" class="text-3xl font-extrabold text-orange-600 mt-2">--</p>
                <p class="text-[10px] text-gray-400 mt-1">(Excluye errores de formato)</p>
            </div>

            <div id="criticality-card" onclick="showCriticalityDocs()" 
                class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-500 cursor-pointer hover:shadow-lg transition duration-200">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">
                    % REGISTROS EN ESTADO CRÍTICO 
                    <span class="ml-1 text-red-400">
                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                </p>
                <p id="pct-criticos" class="text-3xl font-extrabold text-red-600 mt-2">--</p>
                <p class="text-[10px] text-gray-400 mt-1">(Basado en P10 y Consistencia)</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2">
                <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100">
                    
                    <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50/50">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Detalle de Reglas de Calidad</h2>
                            <p class="text-xs text-gray-500 mt-1">Haga clic en una fila para ver el detalle técnico.</p>
                        </div>
                        
                        <div class="flex space-x-1 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                            <button onclick="filterTable('all')" id="btn-all" class="filter-btn active px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Todas</button>
                            <button onclick="filterTable('Formato')" id="btn-fmt" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Formato</button>
                            <button onclick="filterTable('Consistencia')" id="btn-cst" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-indigo-600 transition">Consistencia</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky-header">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Regla (Nombre Legible)</th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Reg. Afectados</th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">% Afectación</th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-gray-50 text-xs text-center text-gray-500 border-t">
                        Mostrando <span id="rows-count" class="font-bold">0</span> reglas activas
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-4 text-sm text-yellow-800">
                    <p class="font-semibold mb-1 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Nota sobre Reglas Activas:
                    </p>
                    <p>Solo se listan las reglas activas. Las reglas con 0 Registros Afectados se filtran porque no se consideran activas para este reporte.</p>
                </div>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-white shadow-xl rounded-xl p-6 border border-gray-100 h-full">
                    <h3 class="text-lg font-bold text-indigo-900 mb-6 flex items-center border-b pb-4">
                        <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Interpretación del Detalle de Reglas
                    </h3>
                    
                    <div class="space-y-8 text-sm text-gray-600">

                        <div>
                            <h4 class="font-bold text-gray-800 mb-4 text-base">Pesos y Ponderación</h4>
                            <p class="mb-4 text-xs leading-relaxed text-gray-500">
                                El puntaje de calidad se calcula penalizando cada error con un peso, siendo los errores de consistencia más graves (Peso Alto = 2) que los de formato (Peso Bajo = 1).
                            </p>
                            
                            <ul class="space-y-4">
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs mr-3">F</div>
                                    <div>
                                        <span class="block font-bold text-gray-900">Errores de Formato</span>
                                        <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">Peso Bajo (1 punto)</span>
                                        <p class="text-xs mt-1 text-gray-500">Sintaxis o caracteres especiales. Impacto menor en el análisis.</p>
                                    </div>
                                </li>
                                <li class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs mr-3">C</div>
                                    <div>
                                        <span class="block font-bold text-gray-900">Errores de Consistencia</span>
                                        <span class="text-xs font-semibold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">Peso Alto (2 puntos)</span>
                                        <p class="text-xs mt-1 text-gray-500">Fallas de lógica (nulos esenciales, valores cero, inconsistencias). Invalidan el dato.</p>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <div class="border-t pt-4 mt-2">
                            <h4 class="font-bold text-gray-800 mb-4 text-base">Sobre el Porcentaje de Afectación (Tabla)</h4>
                            <p class="text-xs leading-relaxed text-gray-500">
                                La columna "% Afectación" en la tabla mide la frecuencia individual con la que la base de datos incumple una única regla.
                            </p>
                        </div>
                        
                        <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-100 relative">
                            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500 rounded-l-lg"></div>
                            <p class="font-bold text-indigo-900 mb-3 text-base">Fórmula del Puntaje de Calidad (SCORE)</p>
                            <div class="font-mono text-xs bg-white p-3 rounded border border-indigo-200 mb-3 text-center text-indigo-700 font-bold shadow-sm">
                                SCORE = 100 - [ (Σ Penalización Ponderada / Total Puntos Posibles) x 100 ]
                            </div>
                            <p class="text-xs leading-relaxed text-indigo-800">
                                El Total Puntos Posibles (T.P.P.) es la suma de los pesos de *todas las reglas* evaluadas, lo que permite normalizar la penalización a un rango de 0 a 100.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div> 
        
    </div>

    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-0 transform transition-all scale-100 overflow-hidden">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg">Detalle de la Regla</h3>
                <button onclick="closeModal()" class="text-indigo-200 hover:text-white text-2xl font-bold leading-none focus:outline-none">&times;</button>
            </div>
            
            <div class="p-6 space-y-5">
                <div>
                    <h4 id="modal-title" class="text-xl font-bold text-gray-800 mb-1">Nombre de la Regla</h4>
                    <p id="modal-technical-name" class="font-mono text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded inline-block border border-indigo-100">nombre_tecnico</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Descripción Técnica</p>
                    <p id="modal-description" class="text-sm text-gray-700 leading-relaxed">Descripción detallada...</p>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded focus:outline-none transition">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="score-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-0 transform transition-all scale-100 overflow-hidden">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    Definición de Score de Calidad Promedio
                </h3>
                <button onclick="closeScoreModal()" class="text-indigo-200 hover:text-white text-2xl font-bold leading-none focus:outline-none">&times;</button>
            </div>
            
            <div class="p-6 space-y-4">
                <p class="text-gray-700 text-base">El Score de Calidad Promedio es la métrica principal que resume la salud general del conjunto de datos. Se calcula a nivel de registro y se promedia para obtener la puntuación general del *dataset*.</p>
                
                <ul class="space-y-3 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <li class="flex items-start">
                        <div>
                            <span class="font-bold text-gray-900 block">Base del Cálculo (Penalización Ponderada)</span>
                            <p class="text-sm text-gray-600">Cada registro inicia con un puntaje base de 100, al que se le resta una penalización por cada regla de calidad fallida. Esta penalización es ponderada (1 punto por error de formato, 2 puntos por error de consistencia).</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div>
                            <span class="font-bold text-gray-900 block">Normalización a 100</span>
                            <p class="text-sm text-gray-600">La penalización total se normaliza utilizando el Total de Puntos Posibles (T.P.P.) para asegurar que el score se mantenga en una escala de 0 a 100, independientemente del número total de reglas aplicadas.</p>
                        </div>
                    </li>
                </ul>
                <div class="bg-indigo-100 p-3 rounded-md text-xs font-semibold text-indigo-800 border border-indigo-200">
                    Este score mide la calidad intrínseca del dato: un score bajo (cercano a 0) indica un registro inservible, mientras que un score de 100 indica un registro perfecto según las reglas definidas.
                </div>
                <div class="flex justify-end pt-3">
                    <button onclick="closeScoreModal()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold py-2 px-4 rounded focus:outline-none transition">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="criticality-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-0 transform transition-all scale-100 overflow-hidden">
            <div class="bg-red-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Definición de Registros Críticos
                </h3>
                <button onclick="closeCriticalityModal()" class="text-red-200 hover:text-white text-2xl font-bold leading-none focus:outline-none">&times;</button>
            </div>
            
            <div class="p-6 space-y-4">
                <p class="text-gray-700 text-base">Un registro se clasifica en Estado Crítico si cumple <span class="font-bold text-red-700">al menos una</span> de las siguientes dos condiciones de extrema severidad:</p>
                
                <ul class="space-y-3 bg-red-50 p-4 rounded-lg border border-red-200">
                    <li class="flex items-start">
                        <span class="text-red-600 font-extrabold text-2xl mr-3 leading-none">1.</span>
                        <div>
                            <span class="font-bold text-gray-900 block">Umbral Dinámico P10 (Score)</span>
                            <p class="text-sm text-gray-600">El registro se encuentra en el 10% inferio de todos los puntajes de calidad, es decir, su `PUNTAJE_CALIDAD` es menor al Percentil 10 (P10) del conjunto de datos.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-red-600 font-extrabold text-2xl mr-3 leading-none">2.</span>
                        <div>
                            <span class="font-bold text-gray-900 block">Falla Catastrófica (Consistencia)</span>
                            <p class="text-sm text-gray-600">El registro acumula 4 o más errores de Consistencia (reglas de lógica de negocio fallidas), indicando una corrupción grave de los campos esenciales.</p>
                        </div>
                    </li>
                </ul>
                <div class="flex justify-end pt-3">
                    <button onclick="closeCriticalityModal()" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded focus:outline-none transition">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hallazgos-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-0 transform transition-all scale-100 overflow-hidden">
            <div class="bg-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Definición de Hallazgos de Consistencia
                </h3>
                <button onclick="closeHallazgosModal()" class="text-orange-200 hover:text-white text-2xl font-bold leading-none focus:outline-none">&times;</button>
            </div>
            
            <div class="p-6 space-y-4">
                <p class="text-gray-700 text-base">Esta métrica mide la cobertura total de los problemas de calidad de la base de datos.</p>
                
                <ul class="space-y-3 bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <li class="flex items-start">
                        <div>
                            <span class="font-bold text-gray-900 block">Propósito (Cobertura General)</span>
                            <p class="text-sm text-gray-600">Representa el porcentaje de registros que tienen al menos un (1) error de Consistencia (lógica de negocio rota o dato nulo esencial). Mide la prevalencia de defectos.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div>
                            <span class="font-bold text-gray-900 block">Diferencia con 'Crítico'</span>
                            <p class="text-sm text-gray-600">Este valor es típicamente más alto que el Estado Crítico (9.05%), ya que incluye errores menores que no afectan drásticamente el puntaje, mientras que el Crítico se enfoca en la severidad.</p>
                        </div>
                    </li>
                </ul>
                <div class="flex justify-end pt-3">
                    <button onclick="closeHallazgosModal()" class="bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold py-2 px-4 rounded focus:outline-none transition">Aceptar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        let fullData = [];

        function initDashboard() {
            // Cargar JSON: busca data_reporte_calidad.json en el mismo directorio.
            fetch('data_reporte_calidad.json')
                .then(res => {
                    if (!res.ok) throw new Error("No se pudo cargar data_reporte_calidad.json");
                    return res.json();
                })
                .then(data => {
                    fullData = data.ruleMetrics;
                    updateExecutiveSummary(data.executiveSummary);
                    filterTable('all'); // Carga inicial de la tabla
                })
                .catch(err => {
                    console.error("Error:", err);
                    document.getElementById('total-registros').textContent = 'ERROR';
                    document.getElementById('puntaje-promedio').textContent = 'N/A';
                    alert("Error: El archivo JSON de datos no se encontró. Por favor, asegúrese de EJECUTAR el script PySpark primero y de que el archivo 'data_reporte_calidad.json' esté en la misma carpeta que este HTML.");
                });
        }

        function updateExecutiveSummary(summary) {
            document.getElementById('puntaje-promedio').textContent = summary.puntaje_promedio;
            document.getElementById('total-registros').textContent = summary.total_registros;
            document.getElementById('pct-criticos').textContent = summary.porcentaje_criticos;
            document.getElementById('total-reglas').textContent = summary.total_reglas;
            document.getElementById('pct-hallazgos').textContent = summary.porcentaje_hallazgos_global;
        }

        function filterTable(type) {
            // 1. Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            
            let activeBtnId = 'btn-all';
            if(type === 'Formato') activeBtnId = 'btn-fmt';
            if(type === 'Consistencia') activeBtnId = 'btn-cst';
            
            const activeBtn = document.getElementById(activeBtnId);
            activeBtn.classList.remove('bg-white', 'text-gray-600');
            activeBtn.classList.add('active');

            // 2. Filtrar Datos
            let filteredData = fullData;
            if (type !== 'all') {
                filteredData = fullData.filter(item => item.type === type);
            }

            renderTable(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            document.getElementById('rows-count').textContent = data.length;

            data.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'data-row border-b border-gray-50 hover:bg-indigo-50 transition duration-150';
                row.onclick = () => showDetails(item);

                // Nombre
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm font-medium text-gray-900">${item.readable_name}</div>`;
                
                // Conteo
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm text-gray-500 text-right font-mono">${item.affected_count}</div>`;

                // Porcentaje
                const pctVal = parseFloat(item.affected_pct.replace('%','').replace(',', '.'));
                let colorClass = 'text-green-600 font-medium';
                if(pctVal > 5) colorClass = 'text-orange-500 font-semibold';
                if(pctVal > 15) colorClass = 'text-red-600 font-bold';

                row.insertCell().innerHTML = `<div class="px-6 py-4 text-sm text-right ${colorClass}">${item.affected_pct}</div>`;

                // Tipo Badge
                const badgeColor = item.type === 'Consistencia' ? 'bg-indigo-100 text-indigo-800 border-indigo-200' : 'bg-blue-100 text-blue-800 border-blue-200';
                row.insertCell().innerHTML = `<div class="px-6 py-4 text-center"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border ${badgeColor}">${item.type}</span></div>`;
            });
        }

        function showDetails(item) {
            document.getElementById('modal-title').textContent = item.readable_name;
            document.getElementById('modal-technical-name').textContent = item.technical_name;
            document.getElementById('modal-description').textContent = item.description;
            
            const modal = document.getElementById('modal-container');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('modal-container');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // --- NUEVAS FUNCIONES AGREGADAS PARA SCORE DE CALIDAD PROMEDIO ---
        function showScoreDocs() {
            const modal = document.getElementById('score-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeScoreModal() {
            const modal = document.getElementById('score-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        // -----------------------------------------------------------------

        // FUNCIONES PARA EL MODAL DE CRITICIDAD
        function showCriticalityDocs() {
            const modal = document.getElementById('criticality-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCriticalityModal() {
            const modal = document.getElementById('criticality-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // FUNCIONES PARA EL MODAL DE HALLAZGOS
        function showHallazgosDocs() {
            const modal = document.getElementById('hallazgos-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHallazgosModal() {
            const modal = document.getElementById('hallazgos-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }


        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.keyCode == 27) {
                closeModal(); 
                closeCriticalityModal(); 
                closeHallazgosModal(); 
                closeScoreModal(); // Integración al cierre por Escape
            }
        };

        window.onload = initDashboard;
    </script>
</body>
</html>